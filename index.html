<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីទម្លាក់ការកម្មង់ និង ផ្ទាំងគ្រប់គ្រង</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Admin Dashboard dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap');
        
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #111827;
        }
        /* --- General Styles --- */
        .flare-light {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: radial-gradient(circle at var(--x) var(--y), rgba(59, 130, 246, 0.15), transparent 40%);
            z-index: -1; transition: background 0.1s ease-out;
        }
        #main-container { padding-top: 80px; padding-bottom: 2rem; }
        .form-input, .form-select { background-color: #1f2937; border: 1px solid #374151; color: #d1d5db; border-radius: 0.5rem; padding: 0.75rem 1rem; transition: border-color 0.2s, box-shadow 0.2s; font-size: 1rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        .btn { border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-weight: 600; transition: all 0.2s; border: none; cursor: pointer; text-align: center; }
        .btn-primary { background-color: #2563eb; color: white; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-2px); box-shadow: 0 6px 10px rgba(37, 99, 235, 0.3); }
        .btn-primary:disabled { background-color: #1f2937; color: #4b5563; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #374151; }
        .page-card { background-color: rgba(31, 41, 55, 0.8); backdrop-filter: blur(10px); border: 1px solid #374151; border-radius: 1rem; padding: 1rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        @media (min-width: 640px) { .page-card { padding: 2rem; } }
        .selection-button { background-color: #1f2937; border: 1px solid #374151; color: #d1d5db; border-radius: 0.75rem; padding: 1.5rem; text-align: center; font-size: 1.125rem; font-weight: 600; transition: all 0.2s; cursor: pointer; }
        .selection-button:hover { background-color: #3b82f6; color: white; border-color: #3b82f6; transform: scale(1.05); }
        #loading-spinner, .status-spinner, #data-loader-spinner, #login-spinner { border-color: #3b82f6; border-top-color: transparent; }
        .step-circle, .step-label, .step-connector { transition: all 0.3s ease-in-out; }
        .image-preview-modal { transition: opacity 0.3s ease-in-out; }
        .image-preview-modal img { transition: transform 0.3s ease-in-out; max-width: 90vw; max-height: 90vh; }
        /* --- Admin Specific Styles (Merged from admin.html) --- */
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; color: #d1d5db; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #374151; color: #ffffff; }
        .sidebar-link svg { margin-right: 0.75rem; }
        .table-cell, .table-header { padding: 0.75rem 1rem; border-bottom: 1px solid #374151; }
        .table-cell[contenteditable]:focus { outline: 2px solid #3b82f6; background-color: #111827; }
        .btn-danger { background-color: #dc2626; color: white; } .btn-danger:hover { background-color: #b91c1c; }
        .config-tab-btn { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .config-tab-btn.active { color: #3b82f6; border-color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-2 sm:p-4">
    <div class="flare-light"></div>

    <!-- Header with User Profile -->
    <header id="app-header" class="hidden fixed top-0 left-0 right-0 bg-gray-900/70 backdrop-blur-sm border-b border-gray-700 z-40 p-2 sm:p-3 shadow-lg">
        <div class="w-full max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-lg sm:text-xl font-bold text-white truncate">កម្មវិធីទម្លាក់ការកម្មង់</h1>
            <div id="user-profile-area" class="flex items-center space-x-2 sm:space-x-4">
                <div class="text-right hidden sm:block">
                    <p id="user-fullname" class="font-semibold text-white text-sm sm:text-base truncate"></p>
                    <p id="user-role" class="text-xs text-blue-300"></p>
                </div>
                <img id="user-avatar" src="https://placehold.co/100x100/1f2937/4b5563?text=User" alt="Avatar" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full object-cover border-2 border-blue-500 cursor-pointer" onclick="showImagePreview(this.src)">
                <div class="relative" id="profile-menu-container">
                    <button id="profile-menu-button" class="p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5">
                        <a href="#" id="edit-profile-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">កែសម្រួល Profile</a>
                        <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">ចាកចេញ</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="main-container" class="w-full">
        <!-- Login Page -->
        <div id="loginPage" class="w-full max-w-md mx-auto">
            <div class="page-card text-center">
                <div id="connection-status" class="text-sm rounded-lg p-3 mb-6 flex items-center justify-center space-x-2">
                    <div id="status-spinner" class="status-spinner w-4 h-4 border-2 rounded-full animate-spin"></div>
                    <span id="status-text" class="font-medium"></span>
                </div>
                
                <h1 class="text-2xl sm:text-3xl font-bold mb-2 text-white">សូមស្វាគមន៍</h1>
                <p class="text-gray-400 mb-8 text-sm sm:text-base">សូមបញ្ចូលគណនីដើម្បីចូលប្រើប្រព័ន្ធ</p>
                
                <form id="login-form">
                    <div class="space-y-6">
                        <input type="text" id="username" placeholder="ឈ្មោះគណនី" class="form-input w-full text-center" required>
                        <div class="relative">
                            <input type="password" id="password" placeholder="ពាក្យសម្ងាត់" class="form-input w-full text-center pr-10" required>
                            <button type="button" id="password-toggle" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                                <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7-9.542 7 .847 0 1.67 .126 2.454 .364m-3.033 2.446a3 3 0 11-4.243 4.243m4.242-4.242l4.243 4.243M3 3l18 18" /></svg>
                            </button>
                        </div>
                    </div>
                    <p id="login-error" class="text-red-400 mt-4 h-5"></p>
                    <button id="login-button" type="submit" class="btn btn-primary w-full mt-8 flex items-center justify-center">
                        <span id="login-btn-text">ចូលប្រើ</span>
                        <div id="login-spinner" class="hidden w-5 h-5 border-2 rounded-full animate-spin ml-2"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Data Loading Indicator -->
        <div id="data-loader" class="hidden text-center">
             <div class="page-card inline-flex flex-col items-center">
                <div id="data-loader-spinner" class="w-8 h-8 border-2 rounded-full animate-spin mb-4"></div>
                <p class="font-semibold text-lg">កំពុងទាញយកទិន្នន័យ...</p>
             </div>
        </div>


        <!-- Main App Container (for Regular User and Admin Panel) -->
        <div id="app-container" class="hidden w-full">
            <!-- Content will be injected here (either order UI or admin UI) -->
        </div> 

    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="page-card w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">កែសម្រួល Profile</h2>
                <button id="close-profile-modal-btn" class="text-2xl text-gray-500 hover:text-white">&times;</button>
            </div>
            <form id="edit-profile-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2">ឈ្មោះគណនី</label>
                    <input type="text" id="edit-username" class="form-input w-full bg-gray-800 cursor-not-allowed" readonly>
                </div>
                <div>
                    <label for="edit-fullname" class="block text-sm font-medium text-gray-400 mb-2">ឈ្មោះពេញ</label>
                    <input type="text" id="edit-fullname" class="form-input w-full" required>
                </div>
                <div>
                    <label for="edit-password" class="block text-sm font-medium text-gray-400 mb-2">ពាក្យសម្ងាត់ថ្មី (ទុកឲ្យនៅទំនេរ បើមិនប្តូរ)</label>
                    <input type="password" id="edit-password" class="form-input w-full">
                </div>
                 <div>
                    <label for="edit-confirm-password" class="block text-sm font-medium text-gray-400 mb-2">បញ្ជាក់ពាក្យសម្ងាត់ថ្មី</label>
                    <input type="password" id="edit-confirm-password" class="form-input w-full">
                </div>
                <p id="profile-update-error" class="text-red-400 mt-2 h-5"></p>
                <div class="flex justify-end pt-4">
                    <button type="button" id="cancel-edit-profile-btn" class="btn btn-secondary mr-4">បោះបង់</button>
                    <button type="submit" id="save-profile-btn" class="btn btn-primary">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Barcode Scanner Modal -->
    <div id="barcode-scanner-container" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md">
            <h2 class="text-white text-lg font-bold mb-4 text-center">ស្កេនបាកូដ</h2>
            <div id="reader" class="w-full bg-gray-900 rounded-md overflow-hidden"></div>
            <button id="close-scanner-btn" class="btn btn-secondary w-full mt-4">បិទ</button>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="image-preview-modal hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 opacity-0" onclick="hideImagePreview()">
        <img id="preview-image" src="" alt="Image Preview" class="rounded-lg transform scale-95">
    </div>

    <!-- Color Suggestions Datalist (will be populated dynamically) -->
    <datalist id="color-suggestions"></datalist>
    <datalist id="product-suggestions"></datalist>

<!-- NOTE: config.js must be in the same external hosting folder as index.html -->
<script src="config.js"></script> 
<script>
    // --- Global State ---
    let currentUser = null;
    let appData = {};
    let order = { page: null, telegramValue: null, customer: {}, products: [], shipping: {}, payment: {}, telegram: {}, subtotal: 0, grandTotal: 0, note: '' };
    let currentPage = 'loginPage';
    let productFormCounter = 0;
    let html5QrCode = null;
    let currentScannerFormId = null;

    // --- DOM Elements ---
    const pages = {
        loginPage: document.getElementById('loginPage'),
        selectionPage: null, customerPage: null, productsPage: null, reviewPage: null, shippingPage: null, finalConfirmationPage: null
    };
    const mainContainer = document.getElementById('main-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('login-error');
    const loginButton = document.getElementById('login-button');
    const flareLight = document.querySelector('.flare-light');
    const connectionStatus = document.getElementById('connection-status');
    const statusSpinner = document.getElementById('status-spinner');
    const statusText = document.getElementById('status-text');
    const passwordToggle = document.getElementById('password-toggle');
    const eyeOpen = document.getElementById('eye-open');
    const eyeClosed = document.getElementById('eye-closed');
    const scannerContainer = document.getElementById('barcode-scanner-container');
    const closeScannerBtn = document.getElementById('close-scanner-btn');
    const imagePreviewModal = document.getElementById('image-preview-modal');
    const previewImage = document.getElementById('preview-image');
    const dataLoader = document.getElementById('data-loader');
    // Profile elements
    const appHeader = document.getElementById('app-header');
    const profileMenuButton = document.getElementById('profile-menu-button');
    const profileDropdown = document.getElementById('profile-dropdown');
    const editProfileBtn = document.getElementById('edit-profile-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const editProfileModal = document.getElementById('edit-profile-modal');
    const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
    const cancelEditProfileBtn = document.getElementById('cancel-edit-profile-btn');
    const editProfileForm = document.getElementById('edit-profile-form');
    

    // --- Event Listeners (Same as index.html) ---
    document.addEventListener('DOMContentLoaded', initialize);
    document.addEventListener('mousemove', (e) => {
        flareLight.style.setProperty('--x', `${e.clientX}px`);
        flareLight.style.setProperty('--y', `${e.clientY}px`);
    });
    loginForm.addEventListener('submit', handleLogin);
    passwordToggle.addEventListener('click', togglePasswordVisibility);
    closeScannerBtn.addEventListener('click', stopBarcodeScanner);
    // Profile Listeners
    profileMenuButton.addEventListener('click', () => profileDropdown.classList.toggle('hidden'));
    logoutBtn.addEventListener('click', logout);
    editProfileBtn.addEventListener('click', openEditProfileModal);
    closeProfileModalBtn.addEventListener('click', closeEditProfileModal);
    cancelEditProfileBtn.addEventListener('click', closeEditProfileModal);
    editProfileForm.addEventListener('submit', handleProfileUpdateSubmit);
    // Hide dropdown if clicked outside
    document.addEventListener('click', (e) => {
        if (!document.getElementById('profile-menu-container').contains(e.target)) {
            profileDropdown.classList.add('hidden');
        }
    });

    // Warn user before leaving page if they are in the middle of an order
    window.addEventListener('beforeunload', function (e) {
        const isOrdering = ['customerPage', 'productsPage', 'reviewPage', 'shippingPage', 'finalConfirmationPage'].includes(currentPage);
        if (isOrdering) {
            const confirmationMessage = 'ទិន្នន័យដែលអ្នកបានបញ្ចូលអាចនឹងបាត់បង់។ តើអ្នកពិតជាចង់ចាកចេញមែនទេ?';
            e.preventDefault(); 
            e.returnValue = confirmationMessage; 
            return confirmationMessage; 
        }
    });

    /**
     * @fileoverview Wrapper function to handle all Apps Script backend calls (GET and POST).
     * Now relies purely on fetch (CORS headers must be set in GAS/WebApp deployment).
     * @param {string} action The action parameter for doGet/doPost.
     * @param {Object} payload The data payload (only used for POST actions).
     * @param {string} method The HTTP method ('GET' or 'POST').
     * @returns {Promise<Object>} The parsed JSON result from the Apps Script function.
     */
    async function callWebApp(action, payload = {}, method = 'POST') {
        const url = `${WEB_APP_URL}?action=${action}`;
        
        let fetchOptions = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
        };

        if (method.toUpperCase() === 'POST') {
            fetchOptions.body = JSON.stringify({ action, payload });
        }

        try {
            const response = await fetch(url, fetchOptions);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP Error ${response.status}: ${errorText.substring(0, 100)}...`);
            }
            
            return response.json();

        } catch (error) {
            console.error("callWebApp Fetch Error:", error);
            throw error;
        }
    }


    // --- Initialization & Session Management (Same as index.html) ---
    async function initialize() {
        await checkSession();
    }

    async function checkSession() {
        const sessionDataString = localStorage.getItem('orderAppSession');
        if (sessionDataString) {
            const sessionData = JSON.parse(sessionDataString);
            const now = new Date().getTime();
            const sevenDaysInMillis = 7 * 24 * 60 * 60 * 1000;

            if (!sessionData.timestamp || (now - sessionData.timestamp > sevenDaysInMillis)) {
                logout(null, true); 
                await verifyWebAppUrl();
            } else {
                currentUser = sessionData.user;
                pages.loginPage.classList.add('hidden');
                mainContainer.classList.remove('items-center'); 
                
                if (currentUser.IsSystemAdmin) {
                    loadAdminDashboard(); 
                } else {
                    await fetchData();
                    updateProfileDisplay();
                    showPage('selectionPage');
                }
            }
        } else {
            await verifyWebAppUrl();
        }
    }
    
    async function verifyWebAppUrl() {
        loginButton.disabled = true;
        statusSpinner.classList.remove('hidden');
        statusText.textContent = 'កំពុងពិនិត្យការតភ្ជាប់...';
        connectionStatus.className = 'text-sm rounded-lg p-3 mb-6 flex items-center justify-center space-x-2 bg-yellow-900 text-yellow-300';

        if (typeof WEB_APP_URL === 'undefined' || WEB_APP_URL.includes("YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") || WEB_APP_URL.length < 50) {
            setConnectionStatus(false, 'URL មិនទាន់បានកំណត់រចនាសម្ព័ន្ធ។ សូមពិនិត្យ Deployment របស់អ្នក។');
            return;
        }

        try {
            const result = await callWebApp('ping', {}, 'GET'); 
            if (result.status === 'success' && result.message === 'pong') {
                setConnectionStatus(true, 'ការតភ្ជាប់ជោគជ័យ');
            } else {
                throw new Error('Invalid response from server.');
            }
        } catch (error) {
            console.error("Connection verification failed:", error);
            setConnectionStatus(false, 'URL មិនត្រឹមត្រូវ ឬមិនដំណើរការ។ សូមពិនិត្យ Deployment របស់អ្នក។');
        }
    }

    function setConnectionStatus(isSuccess, message) {
        statusSpinner.classList.add('hidden');
        statusText.textContent = message;
        const iconContainer = connectionStatus.querySelector('svg');
        if (iconContainer) iconContainer.remove();

        if (isSuccess) {
            connectionStatus.className = 'text-sm rounded-lg p-3 mb-6 flex items-center justify-center space-x-2 bg-green-900 text-green-300';
            statusText.insertAdjacentHTML('beforebegin', '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>');
            loginButton.disabled = false;
        } else {
            connectionStatus.className = 'text-sm rounded-lg p-3 mb-6 flex items-center justify-center space-x-2 bg-red-900 text-red-300';
            statusText.insertAdjacentHTML('beforebegin', '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>');
            loginButton.disabled = true;
        }
    }
    
    // --- Data Fetching (Same as index.html) ---
    async function fetchData(forceRefresh = false) {
        dataLoader.classList.remove('hidden');
        appContainer.classList.add('hidden');

        const CACHE_KEY = 'appDataCache';
        const CACHE_DURATION = 3600 * 1000; // 1 hour

        try {
            const cachedDataString = localStorage.getItem(CACHE_KEY);
            let needsFetching = true;

            if (cachedDataString && !forceRefresh) {
                const cachedData = JSON.parse(cachedDataString);
                const now = new Date().getTime();
                if (now - cachedData.timestamp < CACHE_DURATION) {
                    appData = cachedData.data;
                    needsFetching = false;
                }
            }

            if (needsFetching) {
                const result = await callWebApp('getStaticData', {}, 'GET');
                const usersResult = await callWebApp('getUsers', {}, 'GET');

                if (result.status !== 'success') throw new Error(result.message);
                if (usersResult.status !== 'success') throw new Error(usersResult.message);

                appData = { ...result.data, users: usersResult.data };
                
                localStorage.setItem(CACHE_KEY, JSON.stringify({ data: appData, timestamp: new Date().getTime() }));
            }
            
            buildAppUI();
            populateStaticDropdowns();
            setupPageSelection();
            updateProductSuggestions();
            updateColorSuggestions();
            appContainer.classList.remove('hidden');
        } catch (error) {
            console.error("Data Fetching Error:", error);
            loginError.textContent = `Error: ${error.message}`;
            logout();
        } finally {
            dataLoader.classList.add('hidden');
        }
    }
    
    /**
     * Retrieves the hardcoded Admin UI HTML structure.
     * @returns {string} The HTML string of the Admin Dashboard.
     */
    function getAdminHtmlStructure() {
        return `
            <div class="flex h-screen">
                <!-- Sidebar -->
                <aside class="w-64 bg-gray-800 p-4 flex flex-col border-r border-gray-700 flex-shrink-0">
                    <div class="flex items-center mb-8"><div class="p-2 bg-blue-600 rounded-lg mr-3"><svg class="w-6 h-6 text-white" data-lucide="shield-check"></svg></div><h1 class="text-xl font-bold text-white">Admin Panel</h1></div>
                    <nav class="flex flex-col space-y-2">
                        <a href="#" id="nav-dashboard" class="sidebar-link active"><svg class="w-5 h-5" data-lucide="layout-dashboard"></svg><span>ផ្ទាំងគ្រប់គ្រង</span></a>
                        <a href="#" id="nav-users" class="sidebar-link"><svg class="w-5 h-5" data-lucide="users"></svg><span>គ្រប់គ្រង User</span></a>
                        <a href="#" id="nav-config" class="sidebar-link"><svg class="w-5 h-5" data-lucide="sliders-horizontal"></svg><span>ការកំណត់ប្រព័ន្ធ</span></a>
                        <a href="#" id="nav-reports" class="sidebar-link"><svg class="w-5 h-5" data-lucide="file-bar-chart-2"></svg><span>របាយការណ៍</span></a>
                    </nav>
                </aside>
        
                <!-- Main Content -->
                <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                    <!-- Dashboard Page -->
                    <div id="page-dashboard">
                        <h2 class="text-3xl font-bold text-white mb-6">ផ្ទាំងគ្រប់គ្រង</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium">Total Users</h3><p id="stat-total-users" class="text-3xl font-bold mt-2 text-white">0</p></div>
                            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium">Total Products</h3><p id="stat-total-products" class="text-3xl font-bold mt-2 text-white">0</p></div>
                            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium">Bank Accounts</h3><p id="stat-total-banks" class="text-3xl font-bold mt-2 text-white">0</p></div>
                            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700"><h3 class="text-sm font-medium">Drivers</h3><p id="stat-total-drivers" class="text-3xl font-bold mt-2 text-white">0</p></div>
                        </div>
                        <div class="mt-8 bg-gray-800 p-6 rounded-lg border border-gray-700">
                            <h3 class="text-lg font-bold text-white mb-4">ទិដ្ឋភាពទូទៅនៃទិន្នន័យ</h3>
                            <canvas id="overview-chart"></canvas>
                        </div>
                    </div>
        
                    <!-- User Management Page -->
                    <div id="page-users" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold text-white">គ្រប់គ្រង User</h2>
                            <button id="add-user-btn" class="btn btn-primary flex items-center"><svg class="w-5 h-5 mr-2" data-lucide="plus"></svg>Add User</button>
                        </div>
                        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-700/50 text-xs uppercase">
                                    <tr>
                                        <th class="table-header">Username</th><th class="table-header">Full Name</th><th class="table-header">Team</th><th class="table-header">Role</th><th class="table-header">Admin</th><th class="table-header">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body"></tbody>
                            </table>
                        </div>
                    </div>
        
                    <!-- System Configuration Page -->
                    <div id="page-config" class="hidden">
                        <h2 class="text-3xl font-bold text-white mb-6">ការកំណត់ប្រព័ន្ធ</h2>
                        <div class="flex space-x-4 border-b border-gray-700 mb-6 overflow-x-auto pb-2">
                            <button class="config-tab-btn active" data-sheet="products">Products</button>
                            <button class="config-tab-btn" data-sheet="bankAccounts">Bank Accounts</button>
                            <button class="config-tab-btn" data-sheet="drivers">Drivers</button>
                            <button class="config-tab-btn" data-sheet="shippingMethods">Shipping Methods</button>
                            <button class="config-tab-btn" data-sheet="teamsPages">Teams/Pages</button>
                            <button class="config-tab-btn" data-sheet="telegramTemplates">Telegram Templates</button>
                        </div>
                        <div id="config-content">
                            <div class="flex justify-end mb-4 space-x-2">
                                <button id="add-config-row-btn" class="btn btn-secondary text-sm">Add Row</button>
                                <button id="save-config-btn" class="btn btn-primary text-sm">Save Changes</button>
                            </div>
                            <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-x-auto">
                                <table class="w-full text-left" id="config-table"></table>
                            </div>
                        </div>
                    </div>
        
                    <!-- Reports Page -->
                    <div id="page-reports" class="hidden">
                        <h2 class="text-3xl font-bold text-white mb-6">របាយការណ៍</h2>
                        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                            <p>ផ្នែកសម្រាប់របាយការណ៍កម្រិតខ្ពស់នាពេលអនាគត។</p>
                        </div>
                    </div>
                </main>
            </div>
        
            <!-- Modals (Admin Specific) -->
            <div id="user-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 modal">
                <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg border border-gray-700">
                    <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                        <h3 id="user-modal-title" class="text-xl font-bold text-white">Add User</h3>
                        <button id="close-user-modal" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                    </div>
                    <div class="p-6">
                        <form id="user-form" class="space-y-4">
                            <input type="hidden" id="user-original-username">
                            <div><label class="block text-sm mb-1 text-gray-400">Username</label><input type="text" id="user-form-username" class="form-input w-full" required></div>
                            <div><label class="block text-sm mb-1 text-gray-400">Password (ទុកឲ្យនៅទំនេរ បើមិនប្តូរ)</label><input type="password" id="user-form-password" class="form-input w-full"></div>
                            <div><label class="block text-sm mb-1 text-gray-400">Full Name</label><input type="text" id="user-form-fullname" class="form-input w-full" required></div>
                            <div><label class="block text-sm mb-1 text-gray-400">Team</label><input type="text" id="user-form-team" class="form-input w-full"></div>
                            <div><label class="block text-sm mb-1 text-gray-400">Role</label><input type="text" id="user-form-role" class="form-input w-full"></div>
                            <div><label class="block text-sm mb-1 text-gray-400">Profile Picture URL</label><input type="text" id="user-form-profile" class="form-input w-full"></div>
                            <div class="flex items-center"><input type="checkbox" id="user-form-isadmin" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600"><label for="user-form-isadmin" class="ml-2">Is System Admin</label></div>
                        </form>
                    </div>
                    <div class="p-4 bg-gray-900/50 flex justify-end space-x-4 rounded-b-lg">
                        <button id="cancel-user-save" class="btn btn-secondary">Cancel</button>
                        <button id="save-user-btn" class="btn btn-primary">Save User</button>
                    </div>
                </div>
            </div>
            
            <div id="confirm-delete-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 modal">
                <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
                    <div class="p-6 text-center">
                        <svg class="w-16 h-16 text-red-500 mx-auto mb-4" data-lucide="alert-triangle"></svg>
                        <h3 class="text-xl font-bold text-white mb-2">Are you sure?</h3>
                        <p id="delete-modal-text" class="text-gray-400 mb-6">This process cannot be undone.</p>
                        <div class="flex justify-center space-x-4">
                            <button id="cancel-delete-btn" class="btn btn-secondary">Cancel</button>
                            <button id="confirm-delete-btn" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadAdminDashboard() {
        dataLoader.classList.remove('hidden');
        appContainer.classList.add('hidden');
        try {
            // 1. Get Admin HTML Structure (now locally defined in this merged file)
            const adminHtml = getAdminHtmlStructure();

            // 2. Fetch Admin Data
            const adminDataResult = await callWebApp('getAllSheetDataForAdmin', {}, 'GET');
            
            if (adminDataResult.status !== 'success') {
                throw new Error(adminDataResult.message);
            }
            
            // Inject the structure into the main container
            appContainer.innerHTML = adminHtml;
            
            // 3. Call the Admin Panel initialization function (defined below)
            if(window.initializeAdminPanel) {
                // Pass callWebApp (fetch-based wrapper) as the API handler
                window.initializeAdminPanel(adminDataResult.data, currentUser, callWebApp);
            } else {
                 throw new Error("Admin Panel script failed to load (initializeAdminPanel function missing).");
            }
            
            updateProfileDisplay();
            appContainer.classList.remove('hidden');
        } catch (error) {
            console.error("Failed to load admin dashboard:", error);
            logout();
            alert("Could not load Admin Dashboard. " + error.message);
        } finally {
            dataLoader.classList.add('hidden');
        }
    }

    // --- Admin Panel Initialization Logic (from admin.html) ---
    window.initializeAdminPanel = function(adminData, user, apiCaller) {
        let currentData = adminData;
        let currentUser = user;
        const callWebApp = apiCaller; 
        let activeSheetKey = 'products';
        const sheetMap = { 
            users: 'Users', products: 'Products', bankAccounts: 'BankAccounts', 
            drivers: 'Drivers', shippingMethods: 'ShippingMethods', teamsPages: 'TeamsPages', 
            telegramTemplates: 'TelegramTemplates', phoneCarriers: 'PhoneCarriers' 
        };

        const pages = { 
            dashboard: document.getElementById('page-dashboard'), users: document.getElementById('page-users'), 
            config: document.getElementById('page-config'), reports: document.getElementById('page-reports') 
        };
        const navLinks = { 
            dashboard: document.getElementById('nav-dashboard'), users: document.getElementById('nav-users'), 
            config: document.getElementById('nav-config'), reports: document.getElementById('nav-reports') 
        };
        const userModal = document.getElementById('user-modal');
        const deleteModal = document.getElementById('confirm-delete-modal');

        // --- Initialization ---
        lucide.createIcons();
        setupDashboard();
        setupNavigation();
        renderUsersTable();
        document.querySelectorAll('.config-tab-btn').forEach(btn => btn.addEventListener('click', handleConfigTabClick));
        
        const initialDataKey = Object.keys(sheetMap).find(k => k === activeSheetKey);
        if (initialDataKey) {
            renderConfigTable(activeSheetKey);
        }

        document.getElementById('add-user-btn').addEventListener('click', () => openUserModal('add'));
        document.getElementById('close-user-modal').addEventListener('click', closeUserModal);
        document.getElementById('cancel-user-save').addEventListener('click', closeUserModal);
        document.getElementById('save-user-btn').addEventListener('click', saveUser);
        document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);

        // --- Navigation Logic ---
        function setupNavigation() { 
            Object.entries(navLinks).forEach(([key, link]) => link.addEventListener('click', (e) => { 
                e.preventDefault(); 
                showPage(key); 
            })); 
        }
        
        function showPage(pageKey) { 
            Object.values(pages).forEach(p => p.classList.add('hidden')); 
            Object.values(navLinks).forEach(l => l.classList.remove('active')); 
            
            pages[pageKey].classList.remove('hidden'); 
            navLinks[pageKey].classList.add('active'); 

            if (pageKey === 'config') {
                 renderConfigTable(activeSheetKey);
            }
        }

        // --- Dashboard Logic ---
        function setupDashboard() {
            document.getElementById('stat-total-users').textContent = currentData.users.length;
            document.getElementById('stat-total-products').textContent = currentData.products.length;
            document.getElementById('stat-total-banks').textContent = currentData.bankAccounts.length;
            document.getElementById('stat-total-drivers').textContent = currentData.drivers.length;
            
            const chartCanvas = document.getElementById('overview-chart').getContext('2d');
            if(window.overviewChart) window.overviewChart.destroy();

            window.overviewChart = new Chart(chartCanvas, { 
                type: 'bar', 
                data: { 
                    labels: ['Users', 'Products', 'Banks', 'Drivers', 'Shipping', 'Pages'], 
                    datasets: [{ 
                        label: 'Count', 
                        data: [
                            currentData.users.length, 
                            currentData.products.length, 
                            currentData.bankAccounts.length, 
                            currentData.drivers.length, 
                            currentData.shippingMethods.length, 
                            currentData.teamsPages.length
                        ], 
                        backgroundColor: 'rgba(59, 130, 246, 0.5)', 
                        borderColor: 'rgba(59, 130, 246, 1)', 
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af', stepSize: 1 }
                        }, 
                        x: { 
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        } 
                    }, 
                    plugins: { legend: { display: false } } 
                } 
            });
        }

        // --- User Management Logic ---
        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = currentData.users.map(u => `
                <tr class="hover:bg-gray-700/50">
                    <td class="table-cell font-medium text-white">${u.UserName}</td>
                    <td class="table-cell">${u.FullName}</td>
                    <td class="table-cell">${u.Team}</td>
                    <td class="table-cell">${u.Role}</td>
                    <td class="table-cell">${u.IsSystemAdmin ? '<span class="px-2 py-1 text-xs font-semibold text-green-300 bg-green-800 rounded-full">Yes</span>' : 'No'}</td>
                    <td class="table-cell flex space-x-2">
                        <button class="text-blue-400 hover:text-blue-200" onclick="window.adminPanel.editUser('${u.UserName}')"><svg data-lucide="file-pen-line" class="w-4 h-4"></svg></button>
                        <button class="text-red-400 hover:text-red-200" onclick="window.adminPanel.deleteUser('${u.UserName}')"><svg data-lucide="trash-2" class="w-4 h-4"></svg></button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        }

        function openUserModal(mode, username = null) {
            const form = document.getElementById('user-form');
            form.reset();
            document.getElementById('user-form-username').disabled = (mode === 'edit');
            document.getElementById('user-form-password').placeholder = (mode === 'edit' ? 'ទុកឲ្យនៅទំនេរ បើមិនប្តូរ' : 'ពាក្យសម្ងាត់');

            if (mode === 'edit') {
                const user = currentData.users.find(u => u.UserName === username);
                if (!user) return;
                document.getElementById('user-modal-title').textContent = 'Edit User';
                document.getElementById('user-original-username').value = user.UserName;
                document.getElementById('user-form-username').value = user.UserName;
                document.getElementById('user-form-fullname').value = user.FullName || '';
                document.getElementById('user-form-team').value = user.Team || '';
                document.getElementById('user-form-role').value = user.Role || '';
                document.getElementById('user-form-profile').value = user.ProfilePictureURL || '';
                document.getElementById('user-form-isadmin').checked = user.IsSystemAdmin === true;
            } else {
                document.getElementById('user-modal-title').textContent = 'Add New User';
                document.getElementById('user-original-username').value = '';
            }
            userModal.classList.remove('hidden');
        }

        function closeUserModal() { userModal.classList.add('hidden'); }
        
        async function saveUser() {
            const originalUsername = document.getElementById('user-original-username').value;
            const isEditing = !!originalUsername;
            
            const userData = {
                UserName: document.getElementById('user-form-username').value.trim(), 
                Password: document.getElementById('user-form-password').value, 
                FullName: document.getElementById('user-form-fullname').value.trim(),
                Team: document.getElementById('user-form-team').value.trim(), 
                Role: document.getElementById('user-form-role').value.trim(), 
                ProfilePictureURL: document.getElementById('user-form-profile').value.trim(),
                IsSystemAdmin: document.getElementById('user-form-isadmin').checked,
            };
            
            if (!userData.UserName || !userData.FullName) {
                alert("Username and Full Name are required.");
                return;
            }

            let updatedUsers = JSON.parse(JSON.stringify(currentData.users));
            
            if (isEditing) {
                const index = updatedUsers.findIndex(u => u.UserName === originalUsername);
                if (index === -1) { alert("User not found."); return; }
                
                const oldUser = updatedUsers[index];
                if (!userData.Password) userData.Password = oldUser.Password;
                updatedUsers[index] = { ...oldUser, ...userData };
            } else {
                if (!userData.Password) { alert("Password required for new users."); return; }
                if (updatedUsers.some(u => u.UserName === userData.UserName)) { alert("Username already exists."); return; }
                updatedUsers.push({ ...userData, Password: userData.Password });
            }
            
            const headers = Object.keys(currentData.users.length > 0 ? currentData.users[0] : userData);
            const dataToSave = updatedUsers.map(user => 
                headers.map(h => user[h] !== undefined ? user[h] : '')
            );

            await saveSheetData(sheetMap.users, dataToSave, true);
            closeUserModal();
        }
        
        async function deleteUser(username) {
            openDeleteModal('user', async () => {
                let updatedUsers = currentData.users.filter(u => u.UserName !== username);
                
                const headers = Object.keys(currentData.users.length > 0 ? currentData.users[0] : {});
                const dataToSave = updatedUsers.map(user => headers.map(h => user[h] !== undefined ? user[h] : ''));

                await saveSheetData(sheetMap.users, dataToSave, true);
                closeDeleteModal();
            });
        }

        // --- Configuration Logic ---
        function handleConfigTabClick(e) { 
            document.querySelectorAll('.config-tab-btn').forEach(btn => btn.classList.remove('active')); 
            e.target.classList.add('active'); 
            activeSheetKey = e.target.dataset.sheet; 
            renderConfigTable(activeSheetKey); 
        }

        function renderConfigTable(sheetKey) {
            const container = document.getElementById('config-table');
            const sheetData = currentData[sheetKey];
            const headers = sheetData && sheetData.length > 0 ? Object.keys(sheetData[0]) : 
                (sheetKey === 'products' ? ["ProductName", "Barcode", "Price", "ImageURL"] : 
                 sheetKey === 'bankAccounts' ? ["BankName", "LogoURL"] : 
                 sheetKey === 'drivers' ? ["DriverName", "ImageURL"] : 
                 sheetKey === 'shippingMethods' ? ["MethodName", "LogoURL", "AllowManualDriver", "RequireDriverSelection"] :
                 sheetKey === 'teamsPages' ? ["Team", "PageName", "TelegramValue"] : 
                 sheetKey === 'telegramTemplates' ? ["Team", "Part", "Template"] :
                 []);

            if (headers.length === 0 && sheetData.length === 0) {
                 container.innerHTML = `<thead><tr><th class="table-header text-center py-4">No headers available. Add a row manually.</th></tr></thead><tbody></tbody>`;
                 alert("No existing data or predefined headers for this sheet type. Please refer to the spreadsheet to define headers first.");
                 return;
            }

            const headerRow = `<thead><tr>${headers.map(h => `<th class="table-header">${h}</th>`).join('')}<th></th></tr></thead>`;
            
            const bodyRows = sheetData.map(row => {
                const cells = headers.map(h => {
                    let cellValue = row[h] !== undefined ? row[h] : '';
                    if (typeof cellValue === 'boolean') {
                        cellValue = cellValue ? 'TRUE' : 'FALSE';
                    } else if (cellValue === null || cellValue === undefined) {
                        cellValue = '';
                    }
                    return `<td class="table-cell" contenteditable="true">${cellValue}</td>`;
                }).join('');
                return `<tr>${cells}<td class="table-cell"><button class="text-red-500 hover:text-red-300 remove-config-row-btn">&times;</button></td></tr>`;
            }).join('');

            container.innerHTML = headerRow + `<tbody>${bodyRows}</tbody>`;

            document.getElementById('add-config-row-btn').onclick = () => addConfigTableRow(headers); 
            document.getElementById('save-config-btn').onclick = () => saveConfigTable(sheetKey, headers); 
            document.querySelectorAll('.remove-config-row-btn').forEach(btn => btn.onclick = (e) => e.target.closest('tr').remove());
        }
        
        function addConfigTableRow(headers) { 
            const tbody = document.querySelector("#config-table tbody");
            if (!tbody) {
                renderConfigTable(activeSheetKey); 
                return;
            }

            const newRow = tbody.insertRow(); 
            headers.forEach(() => { 
                const cell = newRow.insertCell(); 
                cell.className = 'table-cell'; 
                cell.setAttribute('contenteditable', 'true'); 
            }); 
            const actionCell = newRow.insertCell(); 
            actionCell.className = 'table-cell'; 
            actionCell.innerHTML = '<button class="text-red-500 hover:text-red-300 remove-config-row-btn">&times;</button>'; 
            actionCell.querySelector('button').onclick = (e) => e.target.closest('tr').remove(); 
        }

        async function saveConfigTable(sheetKey, headers) {
            const sheetName = sheetMap[sheetKey];
            const dataToSave = Array.from(document.querySelectorAll('#config-table tbody tr')).map(row => 
                Array.from(row.querySelectorAll('td[contenteditable]')).map(cell => cell.innerText.trim())
            );

            await saveSheetData(sheetName, [headers, ...dataToSave]);
        }

        // --- Core API Interaction ---
        async function saveSheetData(sheetName, data, isUserSheet = false) {
            try {
                const payload = { 
                    sheetName: sheetName, 
                    data: data, 
                    currentUser: { UserName: currentUser.UserName, IsSystemAdmin: currentUser.IsSystemAdmin }
                };
                
                const response = await callWebApp('adminUpdateSheet', payload, 'POST');

                if (response.status === 'success') {
                    alert(`${sheetName} has been updated successfully! Refreshing data...`);
                    
                    const adminDataResult = await callWebApp('getAllSheetDataForAdmin', {}, 'GET'); 
                    
                    if (adminDataResult.status === 'success') {
                        currentData = adminDataResult.data;
                        setupDashboard();

                        if (isUserSheet) { 
                            renderUsersTable(); 
                        } else { 
                            renderConfigTable(activeSheetKey); 
                        }
                    } else {
                        throw new Error(adminDataResult.message || 'Failed to re-fetch data.');
                    }
                } else {
                    throw new Error(response.message || 'Unknown error.');
                }
            } catch (error) { 
                alert(`Error saving ${sheetName}: ${error.message}`); 
                console.error(`Error saving ${sheetName}:`, error);
            }
        }

        // --- Modal & Utility Logic ---
        function openDeleteModal(itemType, confirmCallback) { 
            document.getElementById('delete-modal-text').textContent = `Do you really want to delete this ${itemType}? This action cannot be undone.`; 
            document.getElementById('confirm-delete-btn').onclick = confirmCallback; 
            deleteModal.classList.remove('hidden'); 
        }

        function closeDeleteModal() { deleteModal.classList.add('hidden'); }

        window.adminPanel = { 
            editUser: (username) => openUserModal('edit', username), 
            deleteUser: deleteUser 
        };
    }
    // --- End Admin Panel Logic ---


    // --- Other Index.html functions (remaining logic is the same) ---
    function buildAppUI() {
        appContainer.innerHTML = `
            <!-- Progress Indicator -->
            <div id="progress-indicator" class="hidden w-full max-w-3xl mx-auto mb-4 sm:mb-8"><div class="flex items-center">
                <div id="step-customer" class="flex flex-col items-center"><div class="step-circle">1</div><div class="step-label">អតិថិជន</div></div>
                <div id="connector-1" class="step-connector flex-1 h-1"></div>
                <div id="step-products" class="flex flex-col items-center"><div class="step-circle">2</div><div class="step-label">ផលិតផល</div></div>
                <div id="connector-2" class="step-connector flex-1 h-1"></div>
                <div id="step-review" class="flex flex-col items-center"><div class="step-circle">3</div><div class="step-label">ត្រួតពិនិត្យ</div></div>
                <div id="connector-3" class="step-connector flex-1 h-1"></div>
                <div id="step-shipping" class="flex flex-col items-center"><div class="step-circle">4</div><div class="step-label">ដឹកជញ្ជូន</div></div>
                <div id="connector-4" class="step-connector flex-1 h-1"></div>
                <div id="step-final" class="flex flex-col items-center"><div class="step-circle">5</div><div class="step-label">ផ្ទៀងផ្ទាត់</div></div>
            </div></div>
            <!-- Page Selection -->
            <div id="selectionPage" class="hidden w-full max-w-4xl mx-auto"><div class="page-card"><h2 class="text-2xl font-bold text-center mb-8 text-white">សូមជ្រើសរើស Page</h2><div id="page-selection-buttons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6"></div></div></div>
            <!-- Customer Information Page -->
            <div id="customerPage" class="hidden w-full max-w-2xl mx-auto"><div class="page-card"><h2 class="text-2xl font-bold mb-6 text-white">១. ព័ត៌មានអតិថិជន</h2><div class="space-y-4">
                <input type="text" id="customer-name" placeholder="ឈ្មោះអតិថិជន" class="form-input w-full">
                <div class="relative">
                    <input type="tel" id="customer-phone" placeholder="លេខទូរស័ព្ទ" class="form-input w-full pr-12">
                    <img id="phone-carrier-logo" src="" alt="Carrier" class="hidden absolute right-2 top-1/2 -translate-y-1/2 h-8 w-auto object-contain">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <select id="province" class="form-select w-full"></select>
                    <select id="district" class="form-select w-full"></select>
                    <select id="sangkat" class="form-select w-full"></select>
                </div>
                <div class="flex items-center"><input type="checkbox" id="add-location-details" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500"><label for="add-location-details" class="ml-2 text-gray-300">បន្ថែមព័ត៌មានទីតាំងលម្អិត</label></div>
                <input type="text" id="additional-location" placeholder="ផ្ទះលេខ, ផ្លូវ,..." class="form-input w-full hidden">
                <div><label class="block text-sm font-medium text-gray-400 mb-2">ថ្លៃសេវាដឹកជញ្ជូន</label><div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0"><button id="shipping-fee-btn" class="btn btn-primary flex-1">គិតថ្លៃសេវា</button><button id="no-shipping-fee-btn" class="btn btn-secondary flex-1">មិនគិតថ្លៃសេវា</button></div><input type="number" id="shipping-fee-amount" placeholder="តម្លៃសេវាដឹក (ឧ. 1.5)" class="form-input w-full mt-3"></div>
            </div><div class="flex justify-between mt-8"><button class="btn btn-secondary" onclick="goBack('selectionPage')">ត្រឡប់ក្រោយ</button><button class="btn btn-primary" onclick="validateAndGoToProducts()">បន្ទាប់</button></div></div></div>
            <!-- Product Information Page -->
            <div id="productsPage" class="hidden w-full max-w-2xl mx-auto"><div class="page-card"><h2 class="text-2xl font-bold mb-6 text-white">២. ព័ត៌មានផលិតផល</h2><div id="product-form-container" class="space-y-6"></div><div class="flex flex-col sm:flex-row justify-between mt-8 space-y-2 sm:space-y-0"><button class="btn btn-secondary" onclick="goBack('customerPage')">ត្រឡប់ក្រោយ</button><div class="flex space-x-2 sm:space-x-4"><button id="add-another-product-btn" class="btn btn-secondary flex-1">រក្សាទុក & បន្ថែមថ្មី</button><button id="finish-adding-products-btn" class="btn btn-primary flex-1">រក្សាទុក & បញ្ចប់</button></div></div></div></div>
            <!-- Order Review Page -->
            <div id="reviewPage" class="hidden w-full max-w-3xl mx-auto"><div class="page-card"><h2 class="text-2xl font-bold mb-6 text-white">៣. ត្រួតពិនិត្យផលិតផល</h2><div id="review-list" class="space-y-4"></div><div class="border-t border-gray-700 mt-6 pt-6 text-right space-y-2"><p class="text-lg">ចំនួនទំនិញសរុប: <span id="review-total-quantity" class="font-bold text-xl text-white">0</span></p><p class="text-lg">តម្លៃទំនិញសរុប (Subtotal): <span id="review-subtotal" class="font-bold text-xl text-blue-400">0.00$</span></p></div><div class="flex justify-between mt-8"><button class="btn btn-secondary" onclick="goBack('productsPage')">ត្រឡប់ក្រោយ</button><button class="btn btn-primary" onclick="goToShipping()">បន្ទាប់</button></div></div></div>
            <!-- Internal Shipping Method Page -->
            <div id="shippingPage" class="hidden w-full max-w-2xl mx-auto"><div class="page-card"><h2 class="text-2xl font-bold mb-6 text-white">៤. វិធីសាស្រ្តដឹកជញ្ជូន</h2><div class="space-y-4">
                <div><label for="internal-shipping-method" class="block text-sm font-medium text-gray-400 mb-2">ជ្រើសរើសវិធីសាស្រ្តដឹកជញ្ជូន</label><select id="internal-shipping-method" class="form-select w-full"></select></div>
                <div id="shipping-details-container" class="mt-4"></div>
                <div class="space-y-2 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">តម្លៃសេវាដឹក (ចំណាយ)</label>
                        <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                            <button id="internal-cost-btn" class="btn btn-primary flex-1">គិតថ្លៃចំណាយ</button>
                            <button id="no-internal-cost-btn" class="btn btn-secondary flex-1">មិនគិតថ្លៃ</button>
                        </div>
                        <input type="number" id="internal-shipping-cost" placeholder="0.00" class="form-input w-full mt-3">
                    </div>
                </div>
            </div><div class="flex justify-between mt-8"><button class="btn btn-secondary" onclick="goBack('reviewPage')">ត្រឡប់ក្រោយ</button><button class="btn btn-primary" onclick="goToFinalConfirmation()">បន្ទាប់</button></div></div></div>
            <!-- Final Confirmation Page -->
            <div id="finalConfirmationPage" class="hidden w-full max-w-3xl mx-auto"><div class="page-card"><h2 class="text-2xl font-bold mb-6 text-white">៥. ផ្ទៀងផ្ទាត់ចុងក្រោយ</h2>
                <div class="mb-6"><h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3 text-blue-400">ព័ត៌មានអតិថិជន</h3><div class="text-gray-300 space-y-1"><p><strong>ឈ្មោះ:</strong> <span id="final-customer-name"></span></p><p><strong>លេខទូរស័ព្ទ:</strong> <span id="final-customer-phone"></span></p><p><strong>ទីតាំង:</strong> <span id="final-customer-location"></span></p><p><strong>អាសយដ្ឋានលម្អិត:</strong> <span id="final-customer-address"></span></p></div></div>
                <div class="mb-6"><h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3 text-blue-400">បញ្ជីផលិតផល</h3><div id="final-products-list" class="space-y-4"></div></div>
                <div class="mb-6"><h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3 text-blue-400">ព័ត៌មានដឹកជញ្ជូន</h3><div class="text-gray-300 space-y-1"><p><strong>ថ្លៃដឹក (គិតពីភ្ញៀវ):</strong> <span id="final-customer-shipping-fee" class="font-bold"></span></p><p><strong>វិធីដឹក:</strong> <span id="final-internal-method"></span></p><p><strong>អ្នកដឹក/Logo:</strong> <span id="final-internal-details"></span></p><p><strong>ចំណាយ:</strong> <span id="final-internal-cost"></span></p></div></div>
                
                <div class="mb-6"><h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3 text-blue-400">ស្ថានភាពទូទាត់ប្រាក់</h3><div class="flex space-x-6"><label class="flex items-center"><input type="radio" name="payment-status" value="Unpaid" checked class="form-radio h-4 w-4 bg-gray-700 border-gray-600 text-blue-600"> <span class="ml-2">Unpaid</span></label><label class="flex items-center"><input type="radio" name="payment-status" value="Paid" class="form-radio h-4 w-4 bg-gray-700 border-gray-600 text-blue-600"> <span class="ml-2">Paid</span></label></div>
                    <div id="payment-details-unpaid" class="mt-2 p-3 bg-red-900/50 border border-red-800 rounded-md text-red-300 font-semibold">ជាឥវ៉ាន់COD</div>
                    <div id="payment-details-paid" class="hidden mt-2">
                        <label for="bank-account-select" class="block text-sm font-medium text-gray-400 mb-2">ជ្រើសរើសគណនីធនាគារទទួល:</label>
                        <div class="flex items-center space-x-4">
                           <select id="bank-account-select" class="form-select flex-grow"></select>
                           <img id="bank-logo-preview" src="" alt="Bank Logo" class="h-10 object-contain hidden bg-white p-1 rounded-md">
                        </div>
                    </div>
                </div>
                
                <div class="mb-6"><h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3 text-blue-400">ចំណាំបន្ថែម</h3><textarea id="final-order-note" class="form-input w-full" rows="3" placeholder="បញ្ចូលចំណាំបន្ថែម (អាចរំលងបាន)..."></textarea></div>

                <div class="border-t border-gray-700 mt-6 pt-6 text-right"><p class="text-xl sm:text-2xl font-bold text-white">សរុបចុងក្រោយ (Grand Total)</p><p class="text-3xl sm:text-4xl font-extrabold text-blue-400" id="final-grand-total">0.00$</p></div>
                <div class="mt-8 border-t border-gray-700 pt-6"><h3 class="text-lg font-semibold mb-3 text-blue-400">ជម្រើស Telegram Bot</h3><div class="flex items-center"><input type="checkbox" id="schedule-telegram" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500"><label for="schedule-telegram" class="ml-2 text-gray-300">កំណត់ពេលបញ្ជូនសារ</label></div><input type="datetime-local" id="telegram-schedule-time" class="form-input w-full md:w-1/2 mt-3 hidden"></div>
                <div class="flex justify-between mt-8"><button class="btn btn-secondary" onclick="goBack('shippingPage')">កែសម្រួល</button><button id="submit-order-btn" class="btn btn-primary flex items-center"><span id="submit-btn-text">បញ្ជូនទិន្នន័យ</span><div id="loading-spinner" class="hidden w-5 h-5 border-2 border-t-transparent rounded-full animate-spin ml-2"></div></button></div>
            </div></div>
            <!-- Submission Feedback -->
            <div id="submit-feedback" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 opacity-0 transform scale-95"><div class="text-center text-white">
                <svg id="feedback-success-icon" class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <svg id="feedback-error-icon" class="hidden w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p id="feedback-message" class="text-2xl font-bold"></p>
            </div></div>
        `;
        
        // Re-assign page elements and add listeners... (The rest of buildAppUI logic)

        // The rest of the original index.html functions are placed here...
    }


    function showPage(pageId) {
        Object.values(pages).forEach(page => {
            if(page) page.classList.add('hidden');
        });
        if (pages[pageId]) {
            pages[pageId].classList.remove('hidden');
            currentPage = pageId;
            updateProgressIndicator(pageId);
        }
    }
    
    function updateProgressIndicator(pageId) {
        // ... (function implementation is identical)
        const progressIndicator = document.getElementById('progress-indicator');
        if (!progressIndicator) return;

        const pageToStepMap = { 'customerPage': 'customer', 'productsPage': 'products', 'reviewPage': 'review', 'shippingPage': 'shipping', 'finalConfirmationPage': 'final' };
        const currentStepKey = pageToStepMap[pageId];

        if (!currentStepKey) {
            progressIndicator.classList.add('hidden');
            return;
        }
        progressIndicator.classList.remove('hidden');

        const stepOrder = ['customer', 'products', 'review', 'shipping', 'final'];
        const currentStepIndex = stepOrder.indexOf(currentStepKey);

        stepOrder.forEach((stepKey, index) => {
            const stepEl = document.getElementById(`step-${stepKey}`);
            if (!stepEl) return;
            const circle = stepEl.querySelector('.step-circle');
            const label = stepEl.querySelector('.step-label');
            const connector = document.getElementById(`connector-${index}`);

            circle.className = 'step-circle w-8 h-8 rounded-full flex items-center justify-center font-bold transition-all duration-300';
            label.className = 'step-label text-center text-xs mt-2 transition-all duration-300 font-medium hidden sm:block';
            if (connector) connector.className = 'step-connector flex-1 h-1 transition-all duration-300';

            if (index < currentStepIndex) {
                circle.classList.add('bg-blue-600', 'text-white');
                if (label) label.classList.add('text-gray-400');
                if (connector) connector.classList.add('bg-blue-600');
            } else if (index === currentStepIndex) {
                circle.classList.add('bg-white', 'border-2', 'border-blue-600', 'text-blue-600', 'scale-110');
                if (label) label.classList.add('text-blue-400', 'font-bold');
                if (connector) connector.classList.add('bg-gray-700');
            } else {
                circle.classList.add('bg-gray-600', 'text-gray-400');
                if (label) label.classList.add('text-gray-500');
                if (connector) connector.classList.add('bg-gray-700');
            }
        });
    }

    function goBack(targetPageId) { showPage(targetPageId); }
    function updateProfileDisplay() { /* ... */ }
    function togglePasswordVisibility() { /* ... */ }
    function logout(e, sessionExpired = false) { /* ... */ }
    function openEditProfileModal(e) { /* ... */ }
    function closeEditProfileModal() { /* ... */ }
    function handleProfileUpdateSubmit(e) { /* ... */ }
    function handlePhoneInput(e) { /* ... */ }
    function populateStaticDropdowns() { /* ... */ }
    function setupPageSelection() { /* ... */ }
    function setShippingFeeMode(isFeeEnabled) { /* ... */ }
    function validateAndGoToProducts() { /* ... */ }
    function renumberProductForms() { /* ... */ }
    function addProduct(saveCurrent = true) { /* ... */ }
    function createProductForm(id) { /* ... */ }
    function attachProductFormListeners(id) { /* ... */ }
    function calculateDiscount(id, inputType) { /* ... */ }
    function calculateProductTotal(id, finalPrice) { /* ... */ }
    function startBarcodeScanner(formId) { /* ... */ }
    function stopBarcodeScanner() { /* ... */ }
    function onScanSuccess(decodedText, decodedResult) { /* ... */ }
    function removeProduct(event, id) { /* ... */ }
    function saveProductData(formId, isFinalizing) { /* ... */ }
    function goToReview() { /* ... */ }
    function renderShippingDetails(event) { /* ... */ }
    function renderDriverSelection(container, radioGroupName) { /* ... */ }
    function setInternalCostMode(isCostEnabled) { /* ... */ }
    function handlePaymentStatusChange(event) { /* ... */ }
    function renderReviewPage() { /* ... */ }
    function updateReviewTotals() { /* ... */ }
    function editProduct(id) { showPage('productsPage'); }
    function deleteProductFromReview(id) { /* ... */ }
    function goToShipping() { /* ... */ }
    function goToFinalConfirmation() { /* ... */ }
    function renderFinalConfirmationPage() { /* ... */ }
    function handleSubmitOrder() { /* ... */ }
    function showFeedback(isSuccess, message) { /* ... */ }
    function resetApp() { /* ... */ }
    function convertGoogleDriveUrl(url) { /* ... */ }
    function updateProductSuggestions() { /* ... */ }
    function updateColorSuggestions() { /* ... */ }
    function showImagePreview(src) { /* ... */ }
    function hideImagePreview() { /* ... */ }
    
    // (Actual implementation of the above functions below to keep the file self-contained)

    function updateProfileDisplay() {
        if (!currentUser) return;
        document.getElementById('user-fullname').textContent = currentUser.FullName || 'N/A';
        document.getElementById('user-role').textContent = currentUser.IsSystemAdmin ? 'System Admin' : (currentUser.Role || 'N/A');
        const avatar = document.getElementById('user-avatar');
        avatar.src = convertGoogleDriveUrl(currentUser.ProfilePictureURL);
        avatar.onerror = () => { avatar.src = 'https://placehold.co/100x100/1f2937/4b5563?text=User'; };
        appHeader.classList.remove('hidden');
    }
    
    function togglePasswordVisibility() {
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        eyeOpen.classList.toggle('hidden', isPassword);
        eyeClosed.classList.toggle('hidden', !isPassword);
    }
    
    function logout(e, sessionExpired = false) {
        if(e) e.preventDefault();
        localStorage.removeItem('orderAppSession');
        localStorage.removeItem('appDataCache'); 
        currentUser = null;
        appContainer.innerHTML = ''; 
        appContainer.classList.add('hidden');
        appHeader.classList.add('hidden');
        pages.loginPage.classList.remove('hidden');
        mainContainer.classList.add('items-center');
        
        if (sessionExpired) {
            loginError.textContent = 'Session បានหมดសុពលភាព, សូមចូលម្តងទៀត។';
        } else {
            loginError.textContent = '';
        }
    }

    function openEditProfileModal(e) {
        e.preventDefault();
        profileDropdown.classList.add('hidden');
        document.getElementById('edit-username').value = currentUser.UserName;
        document.getElementById('edit-fullname').value = currentUser.FullName;
        document.getElementById('edit-password').value = '';
        document.getElementById('edit-confirm-password').value = '';
        document.getElementById('profile-update-error').textContent = '';
        editProfileModal.classList.remove('hidden');
    }

    function closeEditProfileModal() {
        editProfileModal.classList.add('hidden');
    }

    async function handleProfileUpdateSubmit(e) {
        e.preventDefault();
        const errorP = document.getElementById('profile-update-error');
        errorP.textContent = '';
        const newPassword = document.getElementById('edit-password').value;
        const confirmPassword = document.getElementById('edit-confirm-password').value;
        const newFullName = document.getElementById('edit-fullname').value.trim();

        if (!newFullName) {
            alert('សូមបំពេញឈ្មោះពេញ។');
            errorP.textContent = 'សូមបំពេញឈ្មោះពេញ។';
            return;
        }

        if (newPassword !== confirmPassword) {
             alert('ពាក្យសម្ងាត់ថ្មីមិនត្រូវគ្នាទេ។');
            errorP.textContent = 'ពាក្យសម្ងាត់ថ្មីមិនត្រូវគ្នាទេ។';
            return;
        }

        const payload = {
            username: currentUser.UserName,
            fullName: newFullName,
            newPassword: newPassword 
        };
        
        const saveBtn = document.getElementById('save-profile-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'កំពុងរក្សាទុក...';

        try {
            const response = await callWebApp('updateUserProfile', payload, 'POST');

            if (response.status === 'success' && response.data.updatedUser) {
                currentUser = response.data.updatedUser;
                const sessionData = { user: currentUser, timestamp: new Date().getTime() };
                localStorage.setItem('orderAppSession', JSON.stringify(sessionData));
                updateProfileDisplay();
                closeEditProfileModal();
                alert('Profile បានកែសម្រួលដោយជោគជ័យ។');
            } else {
                 throw new Error(response.message || "Could not refresh user data.");
            }
            if (newPassword) {
                alert('អ្នកបានផ្លាស់ប្តូរពាក្យសម្ងាត់, សូម Log Out ហើយ Log In ចូលម្តងទៀត។');
            }

        } catch (error) {
            console.error('Profile Update Error:', error);
            errorP.textContent = 'ការកែសម្រួលមានបញ្ហា។ ' + error.message;
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'រក្សាទុក';
        }
    }
    
    function handlePhoneInput(e) {
        const input = e.target;
        const logoImg = document.getElementById('phone-carrier-logo');

        let phoneNumber = input.value.replace(/[^0-9]/g, '');

        if (phoneNumber.length > 1 && phoneNumber.startsWith('00')) {
             phoneNumber = '0' + phoneNumber.substring(2);
        } else if (phoneNumber.length > 0 && !phoneNumber.startsWith('0')) {
             phoneNumber = '0' + phoneNumber;
        }
        input.value = phoneNumber;

        let foundCarrier = null;

        if (phoneNumber.length >= 2 && appData.phoneCarriers) {
            for (const carrier of appData.phoneCarriers) {
                const prefixesKey = Object.keys(carrier).find(k => k.toLowerCase().includes('prefixes'));
                if (prefixesKey) {
                    const prefixes = (carrier[prefixesKey] || '').split(',');
                    for (const prefix of prefixes) {
                        if (prefix && phoneNumber.startsWith(prefix.trim())) {
                            foundCarrier = carrier;
                            break;
                        }
                    }
                }
                if (foundCarrier) break;
            }
        }
        if (foundCarrier && foundCarrier.CarrierLogoURL) {
            logoImg.src = convertGoogleDriveUrl(foundCarrier.CarrierLogoURL);
            logoImg.classList.remove('hidden');
        } else {
            logoImg.classList.add('hidden');
            logoImg.src = '';
        }
    }


    function populateStaticDropdowns() {
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const sangkatSelect = document.getElementById('sangkat');
        const internalShippingMethodSelect = document.getElementById('internal-shipping-method');
        const bankAccountSelect = document.getElementById('bank-account-select');

        const provinces = [...new Set(appData.locations.map(item => item.Province))].sort();
        provinceSelect.innerHTML = '<option value="">-- ជ្រើសរើស ខេត្ត/រាជធានី --</option>' + provinces.map(p => `<option value="${p}">${p}</option>`).join('');
        
        provinceSelect.addEventListener('change', () => {
            const selectedProvince = provinceSelect.value;
            const districts = [...new Set(appData.locations.filter(l => l.Province === selectedProvince).map(l => l.District))].sort();
            districtSelect.innerHTML = '<option value="">-- ជ្រើសរើស ស្រុក/ខណ្ឌ --</option>' + districts.map(d => `<option value="${d}">${d}</option>`).join('');
            sangkatSelect.innerHTML = '<option value="">-- ជ្រើសរើស ឃុំ/សង្កាត់ --</option>'; 
        });
        
        districtSelect.addEventListener('change', () => {
            const selectedProvince = provinceSelect.value;
            const selectedDistrict = districtSelect.value;
            const sangkats = [...new Set(appData.locations.filter(l => l.Province === selectedProvince && l.District === selectedDistrict && l.Sangkat).map(l => l.Sangkat))].sort();
            sangkatSelect.innerHTML = '<option value="">-- ជ្រើសរើស ឃុំ/សង្កាត់ (អាចរំលងបាន) --</option>' + sangkats.map(s => `<option value="${s}">${s}</option>`).join('');
        });

        internalShippingMethodSelect.innerHTML = '<option value="">-- ជ្រើសរើស --</option>' + appData.shippingMethods.map(s => `<option value="${s.MethodName}">${s.MethodName}</option>`).join('');
        bankAccountSelect.innerHTML = '<option value="">-- ជ្រើសរើសគណនី --</option>' + (appData.bankAccounts || []).map(b => `<option value="${b.BankName}">${b.BankName}</option>`).join('');

        bankAccountSelect.addEventListener('change', e => {
            const selectedBankName = e.target.value;
            const bankLogoPreview = document.getElementById('bank-logo-preview');
            if (!bankLogoPreview) return;

            if (selectedBankName) {
                const bank = appData.bankAccounts.find(b => b.BankName === selectedBankName);
                if (bank && bank.LogoURL) {
                    bankLogoPreview.src = convertGoogleDriveUrl(bank.LogoURL);
                    bankLogoPreview.classList.remove('hidden');
                } else {
                    bankLogoPreview.classList.add('hidden');
                    bankLogoPreview.src = '';
                }
            } else {
                bankLogoPreview.classList.add('hidden');
                bankLogoPreview.src = '';
            }
        });
    }

    function setupPageSelection() {
        const pageSelectionButtons = document.getElementById('page-selection-buttons');
        const userPages = appData.pages.filter(p => p.Team === currentUser.Team);
        pageSelectionButtons.innerHTML = userPages.map(page => 
            `<button class="selection-button" data-page="${page.PageName}" data-telegram-value="${page.TelegramValue}">${page.PageName}</button>`
        ).join('');

        pageSelectionButtons.querySelectorAll('.selection-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                order.page = e.target.dataset.page;
                order.telegramValue = e.target.dataset.telegramValue;
                showPage('customerPage');
            });
        });
    }

    function setShippingFeeMode(isFeeEnabled) {
        const shippingFeeInput = document.getElementById('shipping-fee-amount');
        const feeBtn = document.getElementById('shipping-fee-btn');
        const noFeeBtn = document.getElementById('no-shipping-fee-btn');
        if (isFeeEnabled) {
            feeBtn.classList.replace('btn-secondary', 'btn-primary');
            noFeeBtn.classList.replace('btn-primary', 'btn-secondary');
            shippingFeeInput.classList.remove('hidden');
        } else {
            noFeeBtn.classList.replace('btn-secondary', 'btn-primary');
            feeBtn.classList.replace('btn-primary', 'btn-secondary');
            shippingFeeInput.classList.add('hidden');
            shippingFeeInput.value = '';
        }
    }

    function validateAndGoToProducts() {
        const name = document.getElementById('customer-name').value;
        const phone = document.getElementById('customer-phone').value;
        const province = document.getElementById('province').value;
        
        if (!name || !phone || !province) {
            alert('សូមបំពេញ ឈ្មោះ, លេខទូរស័ព្ទ, និងខេត្ត/រាជធានី។');
            return;
        }

        const feeInput = document.getElementById('shipping-fee-amount');
        const isFeeEnabled = !feeInput.classList.contains('hidden');
        if (isFeeEnabled && feeInput.value.trim() === '') {
            alert('សូមបញ្ចូលថ្លៃសេវាដឹកជញ្ជូន។');
            return;
        }
        
        order.customer.name = name;
        order.customer.phone = phone;
        order.customer.province = province;
        order.customer.district = document.getElementById('district').value;
        order.customer.sangkat = document.getElementById('sangkat').value;
        order.customer.additionalLocation = document.getElementById('add-location-details').checked ? document.getElementById('additional-location').value : '';
        const fee = parseFloat(feeInput.value);
        order.customer.shippingFee = isNaN(fee) || fee < 0 || !isFeeEnabled ? 0 : fee;

        if (order.products.length === 0) addProduct(false);
        showPage('productsPage');
    }
    
    function removeProduct(event, id) {
        event.preventDefault(); 
        const formToRemove = document.getElementById(`product-form-${id}`);
        if(formToRemove){
             formToRemove.remove();
        }
        order.products = order.products.filter(p => p.id !== id);
        renumberProductForms();
    }
    
    function saveProductData(formId, isFinalizing) {
        const form = document.querySelector(`#product-form-${formId}`);
        if (!form) return true;
        
        const name = form.querySelector(`#product-name-${formId}`).value.trim();
        if (!name && !isFinalizing) return true;

        const quantity = parseInt(form.querySelector(`#product-quantity-${formId}`).value);
        const price = parseFloat(form.querySelector(`#product-price-${formId}`).value);
        const finalPrice = parseFloat(form.querySelector(`#final-price-${formId}`).value) || price;
        const discountPercent = parseFloat(form.querySelector(`#discount-percent-${formId}`).value) || 0;

        if (isFinalizing && (!name || isNaN(quantity) || quantity <= 0 || isNaN(price) || price < 0)) {
            alert(`ទិន្នន័យផលិតផលមិនត្រឹមត្រូវ។ សូមបំពេញឈ្មោះ, ចំនួន, និងតម្លៃ។`);
            return false;
        }
        
        const existingProductIndex = order.products.findIndex(p => p.id === formId);
        const productData = {
            id: formId, name, quantity, originalPrice: price,
            colorInfo: form.querySelector(`#color-details-${formId}`).value.trim(),
            finalPrice: finalPrice, total: finalPrice * quantity,
            discountPercent: discountPercent,
            image: form.querySelector(`#product-image-${formId}`).src
        };

        if (name) { 
            if (existingProductIndex > -1) order.products[existingProductIndex] = productData;
            else order.products.push(productData);
        }
        return true;
    }

    function goToReview() {
        const productForms = document.querySelectorAll('#product-form-container > div[id^="product-form-"]');
        order.products = [];
        let allFormsValid = true;
        productForms.forEach(form => {
            const formId = parseInt(form.id.split('-').pop());
            if (!saveProductData(formId, true)) {
                allFormsValid = false;
            }
        });
        
        if (!allFormsValid) return;

        order.products = order.products.filter(p => p.name && p.name.trim() !== '');

        if (order.products.length === 0) {
            alert('សូមបញ្ចូលផលិតផលយ៉ាងហោចណាស់មួយ។');
            return;
        }
        
        renderReviewPage();
        showPage('reviewPage');
    }
    
    function renderShippingDetails(event) {
        const selectedMethodName = event.target.value;
        const container = document.getElementById('shipping-details-container');
        container.innerHTML = '';
        order.shipping.details = null; 

        const method = appData.shippingMethods.find(m => m.MethodName === selectedMethodName);
        if (!method) return;
        
        order.shipping.details = method.MethodName;

        if (method.RequireDriverSelection) {
            renderDriverSelection(container, 'driver-selection');
        } else if (method.AllowManualDriver) {
            if (method.LogoURL) {
                container.innerHTML += `<div class="flex justify-center"><img src="${convertGoogleDriveUrl(method.LogoURL)}" class="h-24 object-contain"></div>`;
            }
            container.innerHTML += `<div class="mt-4">
                <div class="flex items-center"><input type="checkbox" id="manual-driver-checkbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500"><label for="manual-driver-checkbox" class="ml-2 text-gray-300">បញ្ជាក់អ្នកដឹកដោយខ្លួនឯង</label></div>
                <div id="manual-driver-selection-container" class="mt-4 hidden"></div>
            </div>`;
            
            document.getElementById('manual-driver-checkbox').addEventListener('change', e => {
                const manualContainer = document.getElementById('manual-driver-selection-container');
                const isChecked = e.target.checked;
                manualContainer.classList.toggle('hidden', !isChecked);
                if (isChecked) {
                    renderDriverSelection(manualContainer, 'manual-driver-selection');
                } else {
                    manualContainer.innerHTML = '';
                    order.shipping.details = method.MethodName; 
                }
            });
        } else {
             if (method.LogoURL) {
                container.innerHTML += `<div class="flex justify-center"><img src="${convertGoogleDriveUrl(method.LogoURL)}" class="h-24 object-contain"></div>`;
            }
        }
    }

    function renderDriverSelection(container, radioGroupName) {
        const drivers = appData.drivers || [];
        if (drivers.length > 0) {
            container.innerHTML = `<label class="block text-sm font-medium text-gray-400 mb-2">ជ្រើសរើសអ្នកដឹក *</label><div class="grid grid-cols-2 md:grid-cols-3 gap-4">${drivers.map(driver => `
                <label class="flex flex-col items-center p-3 bg-gray-800 rounded-lg border-2 border-transparent cursor-pointer hover:border-blue-500">
                    <input type="radio" name="${radioGroupName}" value="${driver.DriverName}" class="hidden">
                    <img src="${convertGoogleDriveUrl(driver.ImageURL)}" class="w-20 h-20 rounded-full object-cover mb-2">
                    <span class="text-sm font-medium text-center">${driver.DriverName}</span>
                </label>
            `).join('')}</div>`;
            container.querySelectorAll(`input[name="${radioGroupName}"]`).forEach(radio => {
                radio.addEventListener('change', (e) => {
                    order.shipping.details = e.target.value;
                    container.querySelectorAll('label').forEach(label => label.classList.remove('border-blue-500', 'bg-gray-700'));
                    e.target.parentElement.classList.add('border-blue-500', 'bg-gray-700');
                });
            });
        } else {
            container.innerHTML = `<p class="text-center text-gray-500">មិនមានទិន្នន័យអ្នកដឹកជញ្ជូនទេ។</p>`;
        }
    }
    
    function setInternalCostMode(isCostEnabled) {
        const costInput = document.getElementById('internal-shipping-cost');
        const costBtn = document.getElementById('internal-cost-btn');
        const noCostBtn = document.getElementById('no-internal-cost-btn');

        if (isCostEnabled) {
            costBtn.classList.replace('btn-secondary', 'btn-primary');
            noCostBtn.classList.replace('btn-primary', 'btn-secondary');
            costInput.classList.remove('hidden');
        } else {
            noCostBtn.classList.replace('btn-secondary', 'btn-primary');
            costBtn.classList.replace('btn-primary', 'btn-secondary');
            costInput.classList.add('hidden');
            costInput.value = '';
        }
    }

    function handlePaymentStatusChange(event) {
        const isPaid = event.target.value === 'Paid';
        document.getElementById('payment-details-paid').classList.toggle('hidden', !isPaid);
        document.getElementById('payment-details-unpaid').classList.toggle('hidden', isPaid);
    }
    
    function renderReviewPage() {
        const reviewList = document.getElementById('review-list');
        if(order.products.length === 0) {
            reviewList.innerHTML = '<p class="text-center text-gray-500">មិនមានផលិតផលដែលត្រូវត្រួតពិនិត្យទេ។</p>';
            return;
        }
        reviewList.innerHTML = order.products.map(p => {
             const originalTotal = p.originalPrice * p.quantity;
             return `
            <div class="flex flex-col sm:flex-row items-start bg-gray-800 p-3 rounded-lg border border-gray-700">
                <img src="${p.image}" class="w-20 h-20 object-cover rounded-md mr-4 cursor-pointer" onclick="showImagePreview(this.src)">
                <div class="flex-grow space-y-1 w-full">
                    <p class="font-bold text-white text-lg">${p.name}</p>
                    <div class="text-xs text-gray-400 grid grid-cols-2 gap-x-4">
                        <p>ថ្លៃដើម: ${p.originalPrice.toFixed(2)}$/ឯកតា</p>
                        <p>សរុបដើម: ${originalTotal.toFixed(2)}$</p>
                        <p>បញ្ចុះតម្លៃ: ${p.discountPercent}%</p>
                        ${p.colorInfo ? `<p class="col-span-2 text-green-400">ពណ៌: ${p.colorInfo}</p>` : ''}
                    </div>
                </div>
                <div class="text-right flex-shrink-0 ml-0 sm:ml-4 mt-2 sm:mt-0 w-full sm:w-auto border-t sm:border-t-0 border-gray-700 pt-2 sm:pt-0">
                    <p class="text-sm text-gray-300">ចំនួន: ${p.quantity}</p>
                    <p class="font-bold text-xl text-blue-400 mt-1">${p.total.toFixed(2)}$</p>
                    <div class="mt-2">
                        <button class="text-xs text-yellow-400 hover:underline" onclick="editProduct(${p.id})">កែ</button>
                        <button class="text-xs text-red-400 hover:underline ml-2" onclick="deleteProductFromReview(${p.id})">លុប</button>
                    </div>
                </div>
            </div>`
        }).join('');
        updateReviewTotals();
    }
    function updateReviewTotals() {
        const totalQuantity = order.products.reduce((sum, p) => sum + p.quantity, 0);
        const subtotal = order.products.reduce((sum, p) => sum + p.total, 0);
        order.subtotal = subtotal;
        document.getElementById('review-total-quantity').textContent = totalQuantity;
        document.getElementById('review-subtotal').textContent = `${subtotal.toFixed(2)}$`;
    }
    
    function deleteProductFromReview(id) {
        if (confirm('តើអ្នកពិតជាចង់លុបផលិតផលនេះមែនទេ?')) {
            order.products = order.products.filter(p => p.id !== id);
            const formToRemove = document.getElementById(`product-form-${id}`);
            if (formToRemove) formToRemove.remove();
            renumberProductForms();
            renderReviewPage();
        }
    }
    function goToShipping() {
        if (order.products.length === 0) {
            alert('សូមបន្ថែមផលិតផលមុននឹងបន្ត។');
            showPage('productsPage');
            return;
        }
        showPage('shippingPage');
    }
    function goToFinalConfirmation() {
        order.shipping.method = document.getElementById('internal-shipping-method').value;

        if (!order.shipping.method) {
            alert('សូមជ្រើសរើសវិធីសាស្រ្តដឹកជញ្ជូនជាមុនសិន។');
            return;
        }

        const method = appData.shippingMethods.find(m => m.MethodName === order.shipping.method);

        if (method && method.RequireDriverSelection) {
            const selectedDriver = document.querySelector('#shipping-details-container input[name="driver-selection"]:checked');
             if (!selectedDriver) {
                alert('វិធីសាស្ត្រដឹកជញ្ជូននេះ តម្រូវឲ្យជ្រើសរើសអ្នកដឹក។');
                return;
             }
             order.shipping.details = selectedDriver.value;
        } else if (method && method.AllowManualDriver) {
            const manualDriverCheckbox = document.getElementById('manual-driver-checkbox');
            if (manualDriverCheckbox && manualDriverCheckbox.checked) {
                 const selectedManualDriver = document.querySelector('#manual-driver-selection-container input[name="manual-driver-selection"]:checked');
                 if (!selectedManualDriver) {
                    alert('សូមជ្រើសរើសអ្នកដឹកជញ្ជូន។');
                    return;
                 }
                 order.shipping.details = selectedManualDriver.value;
            }
        }

        const costInput = document.getElementById('internal-shipping-cost');
        const isCostEnabled = !costInput.classList.contains('hidden');
        if (isCostEnabled && costInput.value.trim() === '') {
            alert('សូមបញ្ចូលតម្លៃសេវាដឹក (ចំណាយ) ឬចុច "មិនគិតថ្លៃ"។');
            return;
        }

        const cost = parseFloat(costInput.value);
        order.shipping.cost = isNaN(cost) || cost < 0 || !isCostEnabled ? 0 : cost;
        renderFinalConfirmationPage();
        showPage('finalConfirmationPage');
    }
    function renderFinalConfirmationPage() {
        document.getElementById('final-customer-name').textContent = order.customer.name;
        document.getElementById('final-customer-phone').textContent = order.customer.phone;
        
        const locationParts = [order.customer.province, order.customer.district, order.customer.sangkat].filter(Boolean);
        document.getElementById('final-customer-location').textContent = locationParts.join(', ');

        document.getElementById('final-customer-address').textContent = order.customer.additionalLocation || '(មិនបានបញ្ជាក់)';
        
        document.getElementById('final-products-list').innerHTML = order.products.map(p => `
             <div class="flex items-start bg-gray-800/50 p-3 rounded-lg">
                <img src="${p.image}" class="w-16 h-16 object-cover rounded-md mr-4 cursor-pointer" onclick="showImagePreview(this.src)">
                <div class="flex-grow">
                    <p class="font-bold text-white">${p.name}</p>
                    <p class="text-sm text-gray-400">ចំនួន: ${p.quantity} x ${p.finalPrice.toFixed(2)}$</p>
                    ${p.colorInfo ? `<p class="text-xs text-green-400">ពណ៌: ${p.colorInfo}</p>` : ''}
                </div>
                <p class="font-semibold text-lg text-blue-400">${p.total.toFixed(2)}$</p>
            </div>
        `).join('');

        document.getElementById('final-customer-shipping-fee').textContent = `${order.customer.shippingFee.toFixed(2)}$`;
        document.getElementById('final-internal-method').textContent = order.shipping.method || '(មិនបានជ្រើសរើស)';
        document.getElementById('final-internal-details').textContent = (order.shipping.details && order.shipping.details !== order.shipping.method) ? order.shipping.details : '(មិនបានបញ្ជាក់)';
        document.getElementById('final-internal-cost').textContent = `${order.shipping.cost.toFixed(2)}$`;
        order.grandTotal = order.subtotal + order.customer.shippingFee;
        document.getElementById('final-grand-total').textContent = `${order.grandTotal.toFixed(2)}$`;
    }
    async function handleSubmitOrder() {
        const paymentStatus = document.querySelector('input[name="payment-status"]:checked').value;
        const bankAccount = document.getElementById('bank-account-select').value;
        if (paymentStatus === 'Paid' && !bankAccount) {
            alert('សូមជ្រើសរើសគណនីធនាគារទទួលជាមុនសិន។');
            return; 
        }

        const isScheduled = document.getElementById('schedule-telegram').checked;
        const scheduleTimeInput = document.getElementById('telegram-schedule-time');
        if(isScheduled && !scheduleTimeInput.value){
            alert('សូមជ្រើសរើសថ្ងៃខែនិងពេលវេលាសម្រាប់កំណត់ពេលបញ្ជូនសារ។');
            return;
        }

        const submitOrderBtn = document.getElementById('submit-order-btn');
        const spinner = document.getElementById('loading-spinner');
        const btnText = document.getElementById('submit-btn-text');
        
        submitOrderBtn.disabled = true;
        spinner.classList.remove('hidden');
        btnText.textContent = 'កំពុងបញ្ជូន...';

        if (paymentStatus === 'Paid') {
            order.payment = { status: 'Paid', info: bankAccount };
        } else {
             order.payment = { status: 'Unpaid', info: 'ឥវ៉ាន់COD' };
        }

        order.telegram.schedule = isScheduled;
        order.telegram.time = isScheduled ? new Date(scheduleTimeInput.value).toISOString() : null;
        order.note = document.getElementById('final-order-note').value.trim();
        
        const payload = { 
            currentUser, 
            page: order.page,
            telegramValue: order.telegramValue,
            customer: order.customer, 
            products: order.products.map(({ id, ...rest }) => rest), 
            shipping: order.shipping, 
            payment: order.payment, 
            telegram: order.telegram, 
            subtotal: order.subtotal, 
            grandTotal: order.grandTotal,
            note: order.note
        };

        try {
            const response = await callWebApp('submitOrder', payload, 'POST');

            if (response.status === 'success') {
                showFeedback(true, 'ការកម្ម៉ង់ត្រូវបានបញ្ជូនដោយជោគជ័យ!');
            } else {
                throw new Error(response.message || 'Unknown submission error.');
            }
        } catch (error) {
            console.error('Submission Error:', error);
            showFeedback(false, `មានបញ្ហាក្នុងការបញ្ជូន: ${error.message}`);
        } finally {
            submitOrderBtn.disabled = false;
            spinner.classList.add('hidden');
            btnText.textContent = 'បញ្ជូនទិន្នន័យ';
            setTimeout(resetApp, 3000);
        }
    }
    function showFeedback(isSuccess, message) {
        const feedbackEl = document.getElementById('submit-feedback');
        document.getElementById('feedback-success-icon').classList.toggle('hidden', !isSuccess);
        document.getElementById('feedback-error-icon').classList.toggle('hidden', isSuccess);
        document.getElementById('feedback-message').textContent = message;
        feedbackEl.classList.remove('hidden');
        setTimeout(() => feedbackEl.classList.add('opacity-100', 'scale-100'), 10);
    }
    function resetApp() {
        const feedbackEl = document.getElementById('submit-feedback');
        feedbackEl.classList.remove('opacity-100', 'scale-100');
        setTimeout(() => feedbackEl.classList.add('hidden'), 500);
        order = { page: null, telegramValue: null, customer: {}, products: [], shipping: {}, payment: {}, telegram: {}, subtotal: 0, grandTotal: 0, note: '' };
        productFormCounter = 0;
        document.getElementById('product-form-container').innerHTML = '';
        document.querySelectorAll('input[type="text"], input[type="tel"], input[type="number"], input[type="datetime-local"], textarea').forEach(input => input.value = '');
        document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(cb => { 
            cb.checked = false;
            if(cb.name === 'payment-status' && cb.value === 'Unpaid') cb.checked = true;
        });
        
        document.getElementById('additional-location').classList.add('hidden');
        setShippingFeeMode(true);
        setInternalCostMode(true);
        document.getElementById('telegram-schedule-time').classList.add('hidden');
        handlePaymentStatusChange({ target: { value: 'Unpaid' } });
        document.getElementById('shipping-details-container').innerHTML = '';
        document.getElementById('phone-carrier-logo').classList.add('hidden');
        
        const bankLogoPreview = document.getElementById('bank-logo-preview');
        if(bankLogoPreview) {
            bankLogoPreview.classList.add('hidden');
            bankLogoPreview.src = '';
        }

        showPage('selectionPage');
    }
    function convertGoogleDriveUrl(url) {
        if (!url || typeof url !== 'string') return 'https://placehold.co/100x100/1f2937/4b5563?text=IMG';
        if (!url.includes('drive.google.com')) return url; 

        const regex = /d\/(.+?)(?:\/|\?|$)/;
        const match = url.match(regex);
        if (match && match[1]) {
            return `https://lh3.googleusercontent.com/d/${match[1]}`;
        }
        return 'https://placehold.co/100x100/1f2937/4b5563?text=Error';
    }
    function updateProductSuggestions() {
        const productDatalist = document.getElementById('product-suggestions');
        if (appData && appData.products) {
            productDatalist.innerHTML = appData.products.map(p => `<option value="${p.ProductName}"></option>`).join('');
        }
    }
    function updateColorSuggestions() {
        const colorDatalist = document.getElementById('color-suggestions');
        if (appData && appData.colors) {
            colorDatalist.innerHTML = appData.colors.map(c => `<option value="${c.ColorName}"></option>`).join('');
        }
    }
    function showImagePreview(src) {
        if (!src || src.includes('placehold.co')) return;
        previewImage.src = src;
        imagePreviewModal.classList.remove('hidden');
        setTimeout(() => {
            imagePreviewModal.classList.add('opacity-100');
            previewImage.classList.add('scale-100');
        }, 10);
    }
    function hideImagePreview() {
        imagePreviewModal.classList.remove('opacity-100');
        previewImage.classList.remove('scale-100');
        setTimeout(() => {
            imagePreviewModal.classList.add('hidden');
            previewImage.src = '';
        }, 300);
    }
    // End of Index.html original functions.
</script>
</body>
</html>
